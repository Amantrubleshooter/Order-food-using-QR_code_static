{% extends 'base.html' %}

{% block title %}Cart
{% endblock title %}

{% block body %}

<div class="container my-4">
    <h2>Your Cart</h2>
    
    {% if not user.is_authenticated %}
    <!-- Guest Information Section -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Guest Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="guest_name" class="form-label">Your Name (Optional)</label>
                        <input type="text" class="form-control" id="guest_name" name="name" placeholder="Enter your name">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="guest_phone" class="form-label">Phone Number (Optional)</label>
                        <input type="text" class="form-control" id="guest_phone" name="phone" placeholder="Enter your phone">
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Cart Items Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
            <div id="items">
                <!-- Cart items will be displayed here by JavaScript -->
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Total: ‚Çπ<span id="totalPrice">0</span></h4>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Special Instructions Section -->
    <div class="card mb-4">
        <div class="card-header" style="background: #10b981; color: white;">
            <h5 class="mb-0">üìù Special Instructions (Optional)</h5>
        </div>
        <div class="card-body">
            <textarea 
                class="form-control" 
                id="special_instructions" 
                rows="4" 
                placeholder="Any special requests? (e.g., extra spicy, no onions, less oil, allergies, etc.)"
            ></textarea>
            <small class="text-muted">Let us know if you have any dietary requirements or preferences</small>
        </div>
    </div>

    <!-- Place Order Button -->
    <div class="text-end mb-4">
        <form action="/cart" method="post" id="orderForm">
            {% csrf_token %}
            <input type="hidden" name="items_json" id="itemsJson">
            <input type="hidden" name="price" id="totalPriceInput">
            <input type="hidden" name="table_value" id="tableValue">
            <input type="hidden" name="special_instructions" id="specialInstructionsInput">
            
            {% if not user.is_authenticated %}
            <input type="hidden" name="name" id="guestNameInput">
            <input type="hidden" name="phone" id="guestPhoneInput">
            {% endif %}
            
            <button type="button" class="btn btn-success btn-lg" onclick="placeOrder()">
                üçΩ Place Order
            </button>
            <a href="/" class="btn btn-outline-secondary btn-lg">Continue Shopping</a>
        </form>
    </div>
</div>

{% endblock body %}

{% block js %}
<script>
    // Function to update cart display
    function updateCartDisplay() {
        let cart = JSON.parse(localStorage.getItem('cart')) || {};
        let itemsContainer = document.getElementById('items');
        let totalPrice = 0;
        let itemsHtml = '';
        
        if (Object.keys(cart).length === 0) {
            itemsHtml = '<p class="text-muted">Your cart is empty</p>';
        } else {
            itemsHtml = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Item</th><th>Price</th><th>Quantity</th><th>Total</th><th>Action</th></tr></thead><tbody>';
            
            for (let itemId in cart) {
                let item = cart[itemId];
                let itemTotal = item[0] * item[2];
                totalPrice += itemTotal;
                
                itemsHtml += `
                    <tr>
                        <td>${item[1]}</td>
                        <td>‚Çπ${item[2]}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="updateQuantity('${itemId}', -1)">-</button>
                            <span class="mx-2">${item[0]}</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="updateQuantity('${itemId}', 1)">+</button>
                        </td>
                        <td>‚Çπ${itemTotal}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeItem('${itemId}')">Remove</button></td>
                    </tr>
                `;
            }
            
            itemsHtml += '</tbody></table></div>';
        }
        
        itemsContainer.innerHTML = itemsHtml;
        document.getElementById('totalPrice').textContent = totalPrice;
        document.getElementById('totalPriceInput').value = totalPrice;
        
        // Update cart count in navbar
        updateCartCount();
    }

    // Function to update cart count in navbar
    function updateCartCount() {
        let cart = JSON.parse(localStorage.getItem('cart')) || {};
        let totalItems = 0;
        for (let itemId in cart) {
            totalItems += parseInt(cart[itemId][0]);
        }
        document.getElementById('cart').textContent = totalItems;
    }

    // Function to update item quantity
    function updateQuantity(itemId, change) {
        let cart = JSON.parse(localStorage.getItem('cart')) || {};
        
        if (cart[itemId]) {
            cart[itemId][0] = parseInt(cart[itemId][0]) + change;
            
            // Remove item if quantity becomes 0 or less
            if (cart[itemId][0] <= 0) {
                delete cart[itemId];
            }
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartDisplay();
    }

    // Function to remove item
    function removeItem(itemId) {
        let cart = JSON.parse(localStorage.getItem('cart')) || {};
        delete cart[itemId];
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartDisplay();
    }

    // Function to place order
    function placeOrder() {
        let cart = JSON.parse(localStorage.getItem('cart')) || {};
        
        if (Object.keys(cart).length === 0) {
            alert('Your cart is empty!');
            return;
        }
        
        // Set form values
        document.getElementById('itemsJson').value = JSON.stringify(cart);
        document.getElementById('tableValue').value = localStorage.getItem('tableValue') || 'take away';
        
        // NEW: Get special instructions
        document.getElementById('specialInstructionsInput').value = document.getElementById('special_instructions').value || '';
        
        // Set guest information if not logged in
        {% if not user.is_authenticated %}
        document.getElementById('guestNameInput').value = document.getElementById('guest_name').value || 'Guest';
        document.getElementById('guestPhoneInput').value = document.getElementById('guest_phone').value || 'Unknown';
        {% endif %}
        
        // Submit the form
        document.getElementById('orderForm').submit();
    }

    // Initialize cart display when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateCartDisplay();
    });
</script>
{% endblock js %}