{% extends 'base.html' %}

{% block title %}Owner Dashboard
{% endblock title %}

{% block body %}

<style>
  body {
    background: #f5f5f5;
    font-size: 14px;
  }
  
  .orders-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    padding: 10px;
  }
  
  .order-card-compact {
    background: white;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-size: 0.85rem;
    position: relative;
  }
  
  .order-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 2px solid #e5e7eb;
  }
  
  .order-id {
    font-weight: 700;
    font-size: 1rem;
    color: #1f2937;
  }
  
  .order-time {
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin: 5px 0;
  }
  
  .status-pending { background: #fef3c7; color: #92400e; }
  .status-preparing { background: #dbeafe; color: #1e40af; }
  .status-ready { background: #d1fae5; color: #065f46; }
  .status-completed { background: #e5e7eb; color: #374151; }
  
  .payment-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin: 5px 0;
  }
  
  .payment-paid { background: #d1fae5; color: #065f46; }
  .payment-unpaid { background: #fee2e2; color: #991b1b; }
  .payment-pending { background: #fef3c7; color: #92400e; }
  
  .special-note {
    background: #fff3cd;
    border-left: 3px solid #ffc107;
    padding: 6px;
    margin: 6px 0;
    font-size: 0.75rem;
    border-radius: 3px;
  }
  
  .items-list {
    background: #f9fafb;
    padding: 6px;
    border-radius: 5px;
    margin: 6px 0;
    font-size: 0.75rem;
  }
  
  .price-tag {
    color: #10b981;
    font-weight: 700;
    font-size: 1.1rem;
    text-align: right;
  }
  
  .action-buttons {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-top: 8px;
  }
  
  .btn-action {
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: 5px;
    font-weight: 600;
    font-size: 0.75rem;
    cursor: pointer;
  }
  
  .btn-view { background: #3b82f6; color: white; }
  .btn-paid { background: #10b981; color: white; }
  .btn-complete { background: #059669; color: white; }
  .btn-bill { background: #8b5cf6; color: white; }
  
  .section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin: 10px;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
  }
  
  .earnings-box {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin: 10px;
    text-align: center;
  }
  
  .earnings-box h2 {
    font-size: 2rem;
    margin: 10px 0;
  }
  
  .bill-status {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin: 5px 0;
  }
  
  .bill-cleared { background: #d1fae5; color: #065f46; }
  .bill-pending { background: #fef3c7; color: #92400e; }
  
  @media (min-width: 768px) {
    .orders-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

<div class="container-fluid">
  
<!-- TODAY'S SECTION -->
  <div class="section-header">
    <span>ğŸ“… Today - {{ today_date|date:"d M Y" }}</span>
    <span>{{ today_count }} orders</span>
  </div>

  {% if today_orders %}
    <div class="orders-grid">
      {% for o in today_orders %}
      <div class="order-card-compact">
        <div class="order-header">
          <span class="order-id">#{{ o.daily_order_number }}</span>
          <span class="order-time">{{ o.ist_time|date:"g:i A" }}</span>
        </div>
        
        <!-- Table/Take Away label INSIDE card -->
        <div style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 600; margin-bottom: 8px; display: inline-block;">
          {% if o.table == 'take away' %}ğŸš¶ Take Away{% else %}ğŸ½ Table {{ o.table }}{% endif %}
        </div>
        
        <span class="status-badge status-{{ o.status }}">
          {% if o.status == 'pending' %}â³ PENDING
          {% elif o.status == 'preparing' %}ğŸ‘¨â€ğŸ³ PREPARING
          {% elif o.status == 'ready' %}âœ… READY
          {% elif o.status == 'completed' %}ğŸ‰ COMPLETED
          {% endif %}
        </span>
        
        {% if o.payment_status %}
        <span class="payment-badge payment-{{ o.payment_status }}">
          {% if o.payment_status == 'paid' %}âœ… PAID{% else %}âŒ UNPAID{% endif %}
        </span>
        {% endif %}
        
        <!-- Bill Status -->
        {% if o.bill_clear %}
        <span class="bill-status bill-cleared">ğŸ“„ BILL CLEARED</span>
        {% else %}
        <span class="bill-status bill-pending">ğŸ“„ BILL PENDING</span>
        {% endif %}
        
        <div class="items-list">
          {% for item_key, item_values in o.items_json.items %}
          <div><b>{{ item_values.1 }}</b> Ã— {{ item_values.0 }}</div>
          {% endfor %}
        </div>
        
        {% if o.special_instructions %}
        <div class="special-note">
          <b>ğŸ“:</b> {{ o.special_instructions }}
        </div>
        {% endif %}
        
        <div class="price-tag">â‚¹{{ o.price }}</div>
        
        {% if o.status != 'completed' %}
        <div class="action-buttons">
          {% if o.payment_screenshot %}
          <a href="{{ o.payment_screenshot.url }}" target="_blank" class="btn-action btn-view" style="text-decoration: none; text-align: center;">
            ğŸ“¸ View Payment
          </a>
          {% endif %}
          
          {% if o.payment_status == 'unpaid' and o.payment_screenshot %}
          <form method="POST" action="{% url 'mark_paid' o.order_id %}" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" class="btn-action btn-paid">âœ… Mark Paid</button>
          </form>
          {% endif %}
          
          <!-- Bill Generation Button -->
          {% if not o.bill_clear %}
          <button onclick="generateBill('{{ o.table }}', '{{ o.order_id }}', '{{ o.daily_order_number }}')" class="btn-action btn-bill">
            ğŸ“„ Generate Bill
          </button>
          {% endif %}
          
          <form method="POST" action="{% url 'update_order_status' o.order_id %}" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" name="status" value="completed" class="btn-action btn-complete">
              âœ… Complete Order
            </button>
          </form>
        </div>
        {% else %}
        <div style="background: #d1fae5; padding: 8px; border-radius: 5px; text-align: center; margin-top: 8px; font-size: 0.75rem; color: #065f46; font-weight: 600;">
          ğŸ‰ COMPLETED
          {% if not o.bill_clear %}
          <br>
          <button onclick="generateBill('{{ o.table }}', '{{ o.order_id }}', '{{ o.daily_order_number }}')" class="btn-action btn-bill" style="margin-top: 5px;">
            ğŸ“„ Generate Bill
          </button>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info m-3" style="font-size: 0.9rem;">No orders today yet.</div>
  {% endif %}

  <!-- TODAY'S EARNINGS -->
  <div class="earnings-box">
    <h3>ğŸ’° Today's Earnings</h3>
    <h2>â‚¹{{ today_earnings }}</h2>
    <p style="font-size: 0.9rem; opacity: 0.9;">From {{ today_count }} orders</p>
  </div>

  <hr style="margin: 30px 10px; border-top: 3px solid #ddd;">

<!-- YESTERDAY'S SECTION -->
  <div class="section-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
    <span>ğŸ“… Yesterday - {{ yesterday_date|date:"d M Y" }}</span>
    <span>{{ yesterday_count }} orders</span>
  </div>

  {% if yesterday_orders %}
    <div class="orders-grid">
      {% for o in yesterday_orders %}
      <div class="order-card-compact" style="opacity: 0.8;">
        <div class="order-header">
          <span class="order-id">#{{ o.daily_order_number }}</span>
          <span class="order-time">{{ o.ist_time|date:"g:i A" }}</span>
        </div>
        
        <div style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 600; margin-bottom: 8px; display: inline-block;">
          {% if o.table == 'take away' %}ğŸš¶ Take Away{% else %}ğŸ½ Table {{ o.table }}{% endif %}
        </div>
        
        <span class="status-badge status-{{ o.status }}">{{ o.status|upper }}</span>
        
        <!-- Bill Status for Yesterday -->
        {% if o.bill_clear %}
        <span class="bill-status bill-cleared">ğŸ“„ BILL CLEARED</span>
        {% else %}
        <span class="bill-status bill-pending">ğŸ“„ BILL PENDING</span>
        {% endif %}
        
        <div class="items-list">
          {% for item_key, item_values in o.items_json.items %}
          <div><b>{{ item_values.1 }}</b> Ã— {{ item_values.0 }}</div>
          {% endfor %}
        </div>
        
        <div class="price-tag" style="color: #6b7280;">â‚¹{{ o.price }}</div>
        
        <!-- Bill Generation for Yesterday Orders -->
        {% if not o.bill_clear %}
        <div class="action-buttons">
          <button onclick="generateBill('{{ o.table }}', '{{ o.order_id }}', '{{ o.daily_order_number }}')" class="btn-action btn-bill">
            ğŸ“„ Generate Bill
          </button>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info m-3" style="font-size: 0.9rem;">No orders yesterday.</div>
  {% endif %}

  <!-- YESTERDAY'S EARNINGS -->
  <div class="earnings-box" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
    <h3>ğŸ’° Yesterday's Earnings</h3>
    <h2>â‚¹{{ yesterday_earnings }}</h2>
    <p style="font-size: 0.9rem; opacity: 0.9;">From {{ yesterday_count }} orders</p>
  </div>

</div>

{% endblock body %}

{% block js %}
<script>
  function generateBill(table, orderId, dailyOrderNumber) {
    // Generate bill with all details including invoice number
    window.location.href = `/generate_bill?table=${table}&order_id=${orderId}&invoice_no=${dailyOrderNumber}`;
  }
</script>
{% endblock js %}